#!/bin/bash

# Daily "ì•„Â·ì Â·ì €" Insight Pipeline í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

echo "ðŸ§ª Daily Insight Pipeline í…ŒìŠ¤íŠ¸ ì‹œìž‘"
echo "=================================="

# í˜„ìž¬ ë‚ ì§œ
TODAY=$(date +%Y-%m-%d)
echo "ðŸ“… í…ŒìŠ¤íŠ¸ ë‚ ì§œ: $TODAY"

# 1. ë”ë¯¸ ë°ì´í„° í™•ì¸
echo ""
echo "1ï¸âƒ£ ë”ë¯¸ ë°ì´í„° í™•ì¸..."
if [ -f "data/2025-01-15/raw_us.json" ]; then
    echo "âœ… ë¯¸êµ­ ì‹œìž¥ ë”ë¯¸ ë°ì´í„° ì¡´ìž¬"
else
    echo "âŒ ë¯¸êµ­ ì‹œìž¥ ë”ë¯¸ ë°ì´í„° ì—†ìŒ"
    exit 1
fi

if [ -f "data/2025-01-15/raw_kr.json" ]; then
    echo "âœ… í•œêµ­ ì‹œìž¥ ë”ë¯¸ ë°ì´í„° ì¡´ìž¬"
else
    echo "âŒ í•œêµ­ ì‹œìž¥ ë”ë¯¸ ë°ì´í„° ì—†ìŒ"
    exit 1
fi

if [ -f "data/2025-01-15/clean_news.json" ]; then
    echo "âœ… ë‰´ìŠ¤ ë”ë¯¸ ë°ì´í„° ì¡´ìž¬"
else
    echo "âŒ ë‰´ìŠ¤ ë”ë¯¸ ë°ì´í„° ì—†ìŒ"
    exit 1
fi

# 2. ì•„ì¹¨ ì„¸ì…˜ í…ŒìŠ¤íŠ¸
echo ""
echo "2ï¸âƒ£ ì•„ì¹¨ ì„¸ì…˜ í…ŒìŠ¤íŠ¸..."
echo "ðŸŒ… GPT ìš”ì•½ í…ŒìŠ¤íŠ¸ (ì•„ì¹¨)..."

# ë”ë¯¸ ë°ì´í„°ë¥¼ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë³µì‚¬
mkdir -p "data/$TODAY"
cp "data/2025-01-15/raw_us.json" "data/$TODAY/"

# GPT ìš”ì•½ í…ŒìŠ¤íŠ¸ (ì‹¤ì œ API í‚¤ê°€ ì—†ìœ¼ë©´ ë”ë¯¸ ì‘ë‹µ ì‚¬ìš©)
if [ -z "$OPENAI_API_KEY" ]; then
    echo "âš ï¸ OpenAI API í‚¤ê°€ ì—†ì–´ ë”ë¯¸ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤..."
    
    # ë”ë¯¸ ìŠ¬ë¼ì´ë“œ ë°ì´í„° ìƒì„±
    cat > "data/$TODAY/slides_$TODAY.json" << 'EOF'
{
  "slides": [
    {
      "heading": "ðŸŒ… ì˜¤ë²„ë‚˜ì´íŠ¸ ë§ˆì¼“ ë¸Œë¦¬í”„",
      "bullet1": "S&P 500: +1.2% | ë‚˜ìŠ¤ë‹¥: +0.8% | ë‹¬ëŸ¬: -0.3%",
      "bullet2": "BTC: +2.1% | WTI: -1.5% | ì£¼ìš” ë³€ë™ ìš”ì¸",
      "hot": "ðŸ”¥ AI ê´€ë ¨ì£¼ ìƒìŠ¹ì„¸ ì§€ì†"
    },
    {
      "heading": "ðŸ“Š ì£¼ìš” ì§€ìˆ˜ í˜„í™©",
      "bullet1": "S&P 500: 4,850 (+1.2%)",
      "bullet2": "ë‚˜ìŠ¤ë‹¥: 15,200 (+0.8%) | ë‹¤ìš°: 38,500 (+0.9%)",
      "hot": "ðŸ’¡ ê¸°ìˆ ì£¼ ì¤‘ì‹¬ ìƒìŠ¹"
    },
    {
      "heading": "ðŸ’± í™˜ìœ¨ & ì›ìžìž¬",
      "bullet1": "ë‹¬ëŸ¬ì¸ë±ìŠ¤: 102.5 (-0.3%)",
      "bullet2": "WTI: $78.5 (-1.5%) | BTC: $45,200 (+2.1%)",
      "hot": "âš¡ ì•”í˜¸í™”í ìƒìŠ¹ì„¸"
    },
    {
      "heading": "ðŸŽ¯ íˆ¬ìžìž ê´€ì‹¬ì‚¬",
      "bullet1": "AI/ë°˜ë„ì²´ ì£¼ëª©ë°›ì•„",
      "bullet2": "FOMC ì •ì±… ê¸°ëŒ€ê°",
      "hot": "ðŸ“ˆ ì„±ìž¥ì£¼ ì„ í˜¸"
    },
    {
      "heading": "ðŸ”´ Reddit í•«í† í”½",
      "bullet1": "AI ê´€ë ¨ì£¼ í† ë¡  í™œë°œ",
      "bullet2": "FOMC ì •ì±… ì „ë§",
      "hot": "ðŸ’¬ ì»¤ë®¤ë‹ˆí‹° ê´€ì‹¬ ì§‘ì¤‘"
    },
    {
      "heading": "ðŸ”– ë‚´ì¼ ì•„ì¹¨ì—ë„ ì¸ì‚¬ì´íŠ¸!",
      "bullet1": "ë§¤ì¼ ì•„ì¹¨ 7:30 ì—…ë°ì´íŠ¸",
      "bullet2": "ì‹¤ì‹œê°„ ì‹œìž¥ ë™í–¥ ì œê³µ",
      "hot": "ðŸ“± íŒ”ë¡œìš°í•˜ê³  ë†“ì¹˜ì§€ ë§ˆì„¸ìš”!"
    }
  ],
  "thread": {
    "main": "ðŸŒ… ì˜¤ëŠ˜ ì•„ì¹¨ ë¯¸êµ­ ì‹œìž¥ì€ AI ê´€ë ¨ì£¼ ì¤‘ì‹¬ìœ¼ë¡œ ìƒìŠ¹ì„¸ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤. S&P 500ì€ 1.2% ìƒìŠ¹í–ˆê³ , ë‚˜ìŠ¤ë‹¥ë„ 0.8% ì˜¬ëžë„¤ìš”. íŠ¹ížˆ NVIDIA, AMD ë“± AI ë°˜ë„ì²´ì£¼ê°€ ê°•ì„¸ë¥¼ ë³´ì´ê³  ìžˆì–´ìš”. ì˜¤ëŠ˜ í•œêµ­ ì‹œìž¥ë„ ì´ì–´ë°›ì„ê¹Œìš”? ðŸ¤”",
    "comment": "ðŸ’¬ Redditì—ì„œë„ AI ê´€ë ¨ì£¼ í† ë¡ ì´ í™œë°œí•©ë‹ˆë‹¤. 'AIëŠ” ì´ì œ ì‹œìž‘'ì´ë¼ëŠ” ì˜ê²¬ì´ ë§Žì•„ìš”. ì—¬ëŸ¬ë¶„ì€ ì–´ë–¤ ì¢…ëª©ì— ê´€ì‹¬ì´ ìžˆìœ¼ì‹ ê°€ìš”? ðŸ‘‡"
  }
}
EOF

    # ë”ë¯¸ Thread ë°ì´í„° ìƒì„±
    cat > "data/$TODAY/thread_post.json" << 'EOF'
{
  "timestamp": "2025-01-15T07:30:00+09:00",
  "session_type": "morning",
  "thread": {
    "main": "ðŸŒ… ì˜¤ëŠ˜ ì•„ì¹¨ ë¯¸êµ­ ì‹œìž¥ì€ AI ê´€ë ¨ì£¼ ì¤‘ì‹¬ìœ¼ë¡œ ìƒìŠ¹ì„¸ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤. S&P 500ì€ 1.2% ìƒìŠ¹í–ˆê³ , ë‚˜ìŠ¤ë‹¥ë„ 0.8% ì˜¬ëžë„¤ìš”. íŠ¹ížˆ NVIDIA, AMD ë“± AI ë°˜ë„ì²´ì£¼ê°€ ê°•ì„¸ë¥¼ ë³´ì´ê³  ìžˆì–´ìš”. ì˜¤ëŠ˜ í•œêµ­ ì‹œìž¥ë„ ì´ì–´ë°›ì„ê¹Œìš”? ðŸ¤”",
    "comment": "ðŸ’¬ Redditì—ì„œë„ AI ê´€ë ¨ì£¼ í† ë¡ ì´ í™œë°œí•©ë‹ˆë‹¤. 'AIëŠ” ì´ì œ ì‹œìž‘'ì´ë¼ëŠ” ì˜ê²¬ì´ ë§Žì•„ìš”. ì—¬ëŸ¬ë¶„ì€ ì–´ë–¤ ì¢…ëª©ì— ê´€ì‹¬ì´ ìžˆìœ¼ì‹ ê°€ìš”? ðŸ‘‡"
  }
}
EOF

    echo "âœ… ë”ë¯¸ ìŠ¬ë¼ì´ë“œ ë°ì´í„° ìƒì„± ì™„ë£Œ"
else
    echo "ðŸ¤– GPT ìš”ì•½ ì‹¤í–‰ ì¤‘..."
    python scripts/gpt_summarize.py morning
fi

# 3. Carousel ì´ë¯¸ì§€ ìƒì„± í…ŒìŠ¤íŠ¸
echo ""
echo "3ï¸âƒ£ Carousel ì´ë¯¸ì§€ ìƒì„± í…ŒìŠ¤íŠ¸..."
echo "ðŸŽ¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘..."

python scripts/local_carousel.py "data/$TODAY/slides_$TODAY.json"

if [ -d "data/$TODAY/preview" ]; then
    echo "âœ… Carousel ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ"
    echo "ðŸ“ ìƒì„±ëœ ì´ë¯¸ì§€ë“¤:"
    ls -la "data/$TODAY/preview/"
else
    echo "âŒ Carousel ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨"
    exit 1
fi

# 4. Buffer ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸ (DRY RUN)
echo ""
echo "4ï¸âƒ£ Buffer ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸ (DRY RUN)..."
echo "ðŸ“¤ ì—…ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜ ì¤‘..."

python scripts/buffer_uploader.py morning "data/$TODAY/slides_$TODAY.json"

echo ""
echo "ðŸŽ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
echo "=================================="
echo "ðŸ“Š ìƒì„±ëœ íŒŒì¼ë“¤:"
echo "  - ìŠ¬ë¼ì´ë“œ ë°ì´í„°: data/$TODAY/slides_$TODAY.json"
echo "  - Thread ë°ì´í„°: data/$TODAY/thread_post.json"
echo "  - ì´ë¯¸ì§€ë“¤: data/$TODAY/preview/"
echo ""
echo "ðŸ” ë¯¸ë¦¬ë³´ê¸° í™•ì¸:"
echo "  open data/$TODAY/preview/  # macOS"
echo "  # ë˜ëŠ” íŒŒì¼ íƒìƒ‰ê¸°ì—ì„œ data/$TODAY/preview/ í´ë” ì—´ê¸°" 