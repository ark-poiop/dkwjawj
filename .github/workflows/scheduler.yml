name: Daily Market Data Pipeline

on:
  schedule:
    # KST ê¸°ì¤€: 07:05, 15:40, 20:00
    # UTC ê¸°ì¤€: 22:05 (ì „ë‚ ), 06:40, 11:00
    - cron: '5 22 * * *'  # 07:05 KST (22:05 UTC)
    - cron: '40 6 * * *'  # 15:40 KST (06:40 UTC)
    - cron: '0 11 * * *'  # 20:00 KST (11:00 UTC)
  workflow_dispatch:
    inputs:
      session_type:
        description: 'ì‹¤í–‰í•  ì„¸ì…˜ íƒ€ì…'
        required: true
        default: 'morning'
        type: choice
        options:
        - morning
        - afternoon
        - evening

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create data directory
      run: |
        mkdir -p data/$(date +%Y-%m-%d)
        mkdir -p logs
        
    - name: Set up environment variables
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        echo "NEWS_API_KEY=${{ secrets.NEWS_API_KEY }}" >> $GITHUB_ENV
        echo "REDDIT_CLIENT_ID=${{ secrets.REDDIT_CLIENT_ID }}" >> $GITHUB_ENV
        echo "REDDIT_CLIENT_SECRET=${{ secrets.REDDIT_CLIENT_SECRET }}" >> $GITHUB_ENV
        echo "REDDIT_USER_AGENT=${{ secrets.REDDIT_USER_AGENT }}" >> $GITHUB_ENV
        echo "BUFFER_ACCESS_TOKEN=${{ secrets.BUFFER_ACCESS_TOKEN }}" >> $GITHUB_ENV
        echo "BUFFER_PROFILE_ID=${{ secrets.BUFFER_PROFILE_ID }}" >> $GITHUB_ENV
        echo "FRED_API_KEY=${{ secrets.FRED_API_KEY }}" >> $GITHUB_ENV
        echo "THREADS_USERNAME=${{ secrets.THREADS_USERNAME }}" >> $GITHUB_ENV
        echo "THREADS_PASSWORD=${{ secrets.THREADS_PASSWORD }}" >> $GITHUB_ENV
        echo "USE_THREADS_API=${{ secrets.USE_THREADS_API }}" >> $GITHUB_ENV
        echo "FACEBOOK_ACCESS_TOKEN=${{ secrets.FACEBOOK_ACCESS_TOKEN }}" >> $GITHUB_ENV
        echo "IG_USER_ID=${{ secrets.IG_USER_ID }}" >> $GITHUB_ENV
        echo "USE_THREADS_AUTO=${{ secrets.USE_THREADS_AUTO }}" >> $GITHUB_ENV
        echo "TIMEZONE=Asia/Seoul" >> $GITHUB_ENV
        echo "DRY_RUN=false" >> $GITHUB_ENV
        echo "DATA_DIR=data" >> $GITHUB_ENV
        echo "PREVIEW_DIR=preview" >> $GITHUB_ENV
        
    - name: Determine session type
      id: session
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "session_type=${{ github.event.inputs.session_type }}" >> $GITHUB_OUTPUT
        else
          # ìŠ¤ì¼€ì¤„ì— ë”°ë¥¸ ì„¸ì…˜ íƒ€ì… ê²°ì •
          current_hour=$(date -u +%H)
          if [ "$current_hour" = "22" ]; then
            echo "session_type=morning" >> $GITHUB_OUTPUT
          elif [ "$current_hour" = "06" ]; then
            echo "session_type=afternoon" >> $GITHUB_OUTPUT
          elif [ "$current_hour" = "11" ]; then
            echo "session_type=evening" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: Debug environment
      run: |
        echo "=== í™˜ê²½ ë””ë²„ê¹… ==="
        echo "Current directory: $(pwd)"
        echo "Python version: $(python --version)"
        echo "Python path: $(which python)"
        echo "Available scripts:"
        ls -la scripts/
        echo "Environment variables check:"
        echo "OPENAI_API_KEY: ${OPENAI_API_KEY:0:10}..."
        echo "NEWS_API_KEY: ${NEWS_API_KEY:0:10}..."
        echo "BUFFER_ACCESS_TOKEN: ${BUFFER_ACCESS_TOKEN:0:10}..."
        echo "BUFFER_PROFILE_ID: $BUFFER_PROFILE_ID"
        echo "TIMEZONE: $TIMEZONE"
        echo "DRY_RUN: $DRY_RUN"
        
    - name: Test individual scripts
      run: |
        echo "=== ê°œë³„ ìŠ¤í¬ë¦½íŠ¸ í…ŒìŠ¤íŠ¸ ==="
        
        # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
        chmod +x scripts/*.py
        
        # 1. ë¯¸êµ­ ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸
        echo "Testing fetch_us_markets.py..."
        python scripts/fetch_us_markets.py || echo "fetch_us_markets.py failed"
        
        # 2. GPT ìš”ì•½ í…ŒìŠ¤íŠ¸
        echo "Testing gpt_summarize.py..."
        python scripts/gpt_summarize.py morning || echo "gpt_summarize.py failed"
        
    - name: Run pipeline
      run: |
        echo "=== íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ==="
        python scripts/github_scheduler.py ${{ steps.session.outputs.session_type }}
        
        echo "Pipeline completed with exit code: $?"
        
        # ë°ì´í„° ìƒì„± í™•ì¸
        echo "=== ìƒì„±ëœ ë°ì´í„° í™•ì¸ ==="
        ls -la data/$(date +%Y-%m-%d)/ || echo "ë°ì´í„° ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
        
        # í•µì‹¬ íŒŒì¼ ì¡´ì¬ í™•ì¸
        if [ -f "data/$(date +%Y-%m-%d)/slides_$(date +%Y-%m-%d).json" ]; then
          echo "âœ… ìŠ¬ë¼ì´ë“œ ë°ì´í„° ìƒì„± ì„±ê³µ"
        else
          echo "âŒ ìŠ¬ë¼ì´ë“œ ë°ì´í„° ìƒì„± ì‹¤íŒ¨"
        fi
        
        if [ -f "data/$(date +%Y-%m-%d)/thread_post.json" ]; then
          echo "âœ… Thread í¬ìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì„±ê³µ"
        else
          echo "âŒ Thread í¬ìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨"
        fi
        
        # ë¶€ë¶„ì  ì„±ê³µë„ í—ˆìš© (í•µì‹¬ ë°ì´í„°ê°€ ìƒì„±ë˜ì—ˆìœ¼ë©´ ì„±ê³µìœ¼ë¡œ ê°„ì£¼)
        if [ -f "data/$(date +%Y-%m-%d)/slides_$(date +%Y-%m-%d).json" ] && [ -f "data/$(date +%Y-%m-%d)/thread_post.json" ]; then
          echo "ğŸ‰ í•µì‹¬ ë°ì´í„° ìƒì„± ì™„ë£Œ - ì„±ê³µìœ¼ë¡œ ê°„ì£¼"
          exit 0
        else
          echo "âŒ í•µì‹¬ ë°ì´í„° ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pipeline-output-${{ steps.session.outputs.session_type }}-${{ github.run_id }}
        path: |
          data/
          logs/
        retention-days: 7
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Pipeline failed for session: ${{ steps.session.outputs.session_type }}"
        echo "Check the logs for more details" 